<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKK Ketinggian Automation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100px); opacity: 0; }
        }
        
        .simple-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            min-width: 250px;
            max-width: 350px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.5s ease-out;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .notification-success {
            background: linear-gradient(135deg, #6f42c1 0%, #007bff 100%);
            box-shadow: 0 10px 20px rgba(111, 66, 193, 0.4);
        }
        
        .notification-error {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.4);
        }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            opacity: 0.7;
        }
        
        .notification-close:hover {
            opacity: 1;
        }

        /* Shift button styles */
        .shift-btn {
            min-width: 40px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .shift-btn.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-color: #28a745;
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            transform: scale(1.05);
        }
        
        .shift-btn:hover:not(.selected) {
            background-color: #e9ecef;
            border-color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-building text-info me-2"></i>IKK Ketinggian Automation</h1>
                <p class="text-muted mb-0">Izin Kerja Khusus untuk pekerjaan di ketinggian atau height work</p>
            </div>
            <a href="/ikk" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to IKK Categories
            </a>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-lg-7 col-12">
                <div class="card border-info h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Work Date & Process Control</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6 col-12 mb-2 mb-md-0">
                                <div class="d-flex gap-3 align-items-center flex-wrap">
                                    <div class="d-flex gap-2 align-items-center">
                                        <label for="selectedDate" class="form-label mb-0">Date:</label>
                                        <input type="date" id="selectedDate" class="form-control form-control-sm" style="max-width: 160px;" value="{{ today_date }}">
                                    </div>
                                    <div class="d-flex gap-2 align-items-center">
                                        <label class="form-label mb-0">Shift:</label>
                                        <div class="btn-group" role="group" aria-label="Shift selection">
                                            <button type="button" class="btn btn-outline-info btn-sm shift-btn" data-shift="1" onclick="selectShift(1)">1</button>
                                            <button type="button" class="btn btn-outline-info btn-sm shift-btn" data-shift="2" onclick="selectShift(2)">2</button>
                                            <button type="button" class="btn btn-outline-info btn-sm shift-btn" data-shift="3" onclick="selectShift(3)">3</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-12 text-md-end text-start">
                                <div class="d-flex gap-2 justify-content-md-end justify-content-start">
                                    <button class="btn btn-info" onclick="processData('IKK-KETINGGIAN')" id="processBtn">
                                        <i class="bi bi-play-circle me-1"></i>Start Process
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="stopProcess()" id="stopBtn" style="display: none;">
                                        <i class="bi bi-stop-circle me-1"></i>Stop
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-12">
                <div class="card h-100 position-relative">
                    <div class="card-header bg-secondary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Process Log</h6>
                            <button class="btn btn-outline-light btn-sm" type="button" onclick="toggleLog()" id="logToggle">
                                <i class="bi bi-eye me-1"></i>Show Log
                            </button>
                        </div>
                    </div>
                    <div class="collapse" id="processLog">
                        <div class="card-body bg-dark text-light" style="font-family: 'Courier New', monospace; min-height: 180px;">
                            <pre id="logOutput" class="mb-0 text-light">üí¨ Waiting for process to start...</pre>
                        </div>
                    </div>
                    <!-- Floating log button -->
                    <button id="floatingLogBtn" onclick="toggleLog()" style="position:fixed;bottom:30px;right:30px;z-index:1050;display:block;background:#343a40;color:#fff;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:1.5rem;display:flex;align-items:center;justify-content:center;">
                        <i class="bi bi-terminal"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Personnel Data - IKK Ketinggian</h6>
                    <small class="text-muted">Select rows to process</small>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="select-all" onclick="toggleSelectAll()" class="form-check-input">
                                </th>
                                <th>Select All</th>
                                {% for header in csv_data[0][1:] %}
                                <th>{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in csv_data[1:] %}
                            <tr onclick="toggleRowSelection(this)" style="cursor: pointer;">
                                <td><input type="checkbox" class="row-checkbox form-check-input"></td>
                                {% for cell in row %}
                                <td>{{ cell }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let logVisible = false;
        let logInterval;
        
        // ENSURE GLOBAL SCOPE FOR selectedShift
        window.selectedShift = 1; // Default shift - make it explicitly global
        let selectedShift = window.selectedShift; // Local reference

        function selectShift(shift) {
            // ENSURE BOTH GLOBAL AND LOCAL ARE UPDATED
            selectedShift = shift;
            window.selectedShift = shift;
            
            // Update button appearance - simple and clean like IKH
            document.querySelectorAll('.shift-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.classList.add('btn-outline-info');
                btn.classList.remove('btn-success');
            });
            
            const selectedBtn = document.querySelector(`[data-shift="${shift}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                selectedBtn.classList.remove('btn-outline-info');
                selectedBtn.classList.add('btn-success');
            }
            
            // Store in sessionStorage
            try {
                sessionStorage.setItem('ikk_ketinggian_selected_shift', shift.toString());
            } catch (e) {
                console.warn('Could not store in sessionStorage:', e);
            }
            
            // IMMEDIATE TEST - log selectedShift value
            console.log(`‚úÖ Shift ${shift} selected - selectedShift variable: ${selectedShift}`);
            console.log(`‚úÖ Shift ${shift} selected - window.selectedShift: ${window.selectedShift}`);
            
            // Test function to verify value anytime
            window.testCurrentShift = function() {
                console.log(`Current selectedShift: ${selectedShift} (type: ${typeof selectedShift})`);
                console.log(`Current window.selectedShift: ${window.selectedShift} (type: ${typeof window.selectedShift})`);
                return selectedShift;
            };
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const selectAll = document.getElementById('select-all');
            checkboxes.forEach(checkbox => checkbox.checked = selectAll.checked);
            updateButtonText();
        }

        function toggleRowSelection(row) {
            const checkbox = row.querySelector('.row-checkbox');
            checkbox.checked = !checkbox.checked;
            updateButtonText();
        }

        function updateButtonText() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const processBtn = document.getElementById('processBtn');
            const count = checkedBoxes.length;
            
            if (count > 0) {
                processBtn.innerHTML = `<i class="bi bi-play-circle me-1"></i>Process ${count} Selected`;
                processBtn.className = 'btn btn-info';
            } else {
                processBtn.innerHTML = `<i class="bi bi-play-circle me-1"></i>Start Process`;
                processBtn.className = 'btn btn-info';
            }
        }

        function processData(mode) {
            // Reset notification flags for new process
            window.completionNotificationShown = false;
            window.errorNotificationShown = false;
            
            const selectedIndices = [];
            const selectedRows = [];
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                if (row.querySelector('.row-checkbox').checked) {
                    selectedIndices.push(index);
                    const cells = row.querySelectorAll('td');
                    const rowData = Array.from(cells).slice(1).map(cell => cell.textContent.trim());
                    selectedRows.push(rowData);
                }
            });

            if (selectedIndices.length === 0) {
                showAlert('‚ö†Ô∏è Please select at least one row to process!', 'warning');
                return;
            }

            const selectedDate = document.getElementById('selectedDate').value;
            
            // COMPREHENSIVE SHIFT DEBUGGING
            console.log('=== SHIFT DEBUG START ===');
            console.log(`üìä selectedShift variable: ${selectedShift} (${typeof selectedShift})`);
            console.log(`üìä window.selectedShift: ${window.selectedShift} (${typeof window.selectedShift})`);
            
            // USE WINDOW VARIABLE AS AUTHORITATIVE SOURCE
            const finalShift = window.selectedShift || selectedShift || 1;
            console.log(`üìä FINAL AUTHORITATIVE SHIFT: ${finalShift}`);
            
            // Check all shift buttons to see which one is actually selected
            const allShiftBtns = document.querySelectorAll('.shift-btn');
            allShiftBtns.forEach((btn, idx) => {
                const isSelected = btn.classList.contains('selected');
                const shift = btn.getAttribute('data-shift');
                console.log(`Button ${idx}: shift=${shift}, selected=${isSelected}`);
            });
            
            // Use testCurrentShift function if available
            if (window.testCurrentShift) {
                const testResult = window.testCurrentShift();
                console.log(`Test function result: ${testResult}`);
            }
            
            // Final value to send - use authoritative source
            console.log(`üöÄ WILL SEND TO BACKEND: ${finalShift}`);
            console.log('=== SHIFT DEBUG END ===');
            
            const processBtn = document.getElementById('processBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            processBtn.innerHTML = '<i class="bi bi-gear-fill me-1"></i>Processing...';
            processBtn.disabled = true;
            processBtn.className = 'btn btn-info';
            stopBtn.style.display = 'inline-block'; // Show stop button

            fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    selected_indices: selectedIndices,
                    selected_rows: selectedRows,
                    selected_date: selectedDate,
                    selected_shift: finalShift,
                    mode 
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Data sent to backend:', { selected_indices: selectedIndices, selected_date: selectedDate, selected_shift: finalShift, mode });
                
                // Start log polling immediately but with better timing
                startLogPolling();
                
                // Start polling for completion with delay
                let completionCheckCount = 0;
                const maxChecks = 300; // 5 minutes max
                
                function pollForCompletion() {
                    completionCheckCount++;
                    
                    // Don't check completion too early - wait at least 10 seconds
                    if (completionCheckCount < 10) {
                        setTimeout(pollForCompletion, 1000);
                        return;
                    }
                    
                    // Stop checking after max attempts
                    if (completionCheckCount > maxChecks) {
                        console.log('Max completion checks reached');
                        return;
                    }
                    
                    fetch('/get_log', {cache: 'no-store'})
                        .then(response => response.text())
                        .then(log => {
                            // Enhanced completion detection with stricter patterns
                            const completionPatterns = [
                                '‚ö°‚ö°‚ö° LIGHTNING AUTOMATION COMPLETED! ‚ö°‚ö°‚ö°',
                                '‚úÖ IKK AUTOMATION COMPLETED SUCCESSFULLY!',
                                'üéâ AUTOMATION SELESAI! Tekan Enter untuk menutup browser...'
                            ];
                            
                            const errorPatterns = [
                                '‚ö° Automation error:',
                                '‚ùå AUTOMATION ERROR:',
                                '‚ùå Error:',
                                'IKK AUTOMATION ERROR',
                                'AUTOMATION FAILED'
                            ];
                            
                            const isCompleted = completionPatterns.some(pattern => log.includes(pattern));
                            const hasError = errorPatterns.some(pattern => log.includes(pattern));
                            
                            if (isCompleted && !hasError) {
                                if (!window.completionNotificationShown) {
                                    window.completionNotificationShown = true;
                                    stopLogPolling();
                                    processBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Completed!';
                                    processBtn.disabled = false;
                                    processBtn.className = 'btn btn-success';
                                    document.getElementById('stopBtn').style.display = 'none';
                                    setTimeout(() => { updateButtonText(); }, 3000);
                                    showSuccessNotification();
                                }
                            } else if (hasError) {
                                if (!window.errorNotificationShown) {
                                    window.errorNotificationShown = true;
                                    stopLogPolling();
                                    processBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error!';
                                    processBtn.disabled = false;
                                    processBtn.className = 'btn btn-danger';
                                    document.getElementById('stopBtn').style.display = 'none';
                                    setTimeout(() => { updateButtonText(); }, 3000);
                                    showErrorNotification();
                                }
                            } else {
                                // Continue polling with longer interval
                                setTimeout(pollForCompletion, 2000);
                            }
                        })
                        .catch(error => {
                            console.error('Completion polling error:', error);
                            setTimeout(pollForCompletion, 3000);
                        });
                }
                
                // Start completion polling after 10 second delay
                setTimeout(pollForCompletion, 10000);
            })
            .catch(error => {
                processBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error!';
                processBtn.disabled = false;
                processBtn.className = 'btn btn-danger';
                
                setTimeout(() => {
                    updateButtonText();
                }, 3000);
                
                console.error('Error:', error);
                showAlert('Error processing request', 'danger');
            });
        }

        function showSuccessNotification() {
            const notification = document.createElement('div');
            notification.className = 'simple-notification notification-success';
            notification.id = 'successNotification';
            notification.innerHTML = `
                <div class="text-center">
                    <div class="mb-2">
                        <i class="bi bi-building" style="font-size: 2rem; color: #ffffff; text-shadow: 0 0 10px rgba(255,255,255,0.5);"></i>
                    </div>
                    <div class="mb-2">
                        <h4 class="mb-1" style="font-size: 1.2rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            üèóÔ∏è IKK-IK COMPLETED! üèóÔ∏è
                        </h4>
                    </div>
                    <div class="mb-2" style="font-size: 0.9rem; opacity: 0.95;">
                        <div class="mb-1">‚ö° Height work automation finished!</div>
                    </div>
                    <button class="btn btn-light btn-sm px-3" onclick="closeNotification('successNotification')" style="border-radius: 15px; font-weight: 600;">
                        <i class="bi bi-building me-1"></i>Great!
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                closeNotification('successNotification');
            }, 8000);
        }

        function showErrorNotification() {
            const notification = document.createElement('div');
            notification.className = 'simple-notification notification-error';
            notification.id = 'errorNotification';
            notification.innerHTML = `
                <div class="text-center">
                    <div class="mb-2">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem; color: #ffffff; text-shadow: 0 0 10px rgba(255,255,255,0.5);"></i>
                    </div>
                    <div class="mb-1">
                        <h4 class="mb-1" style="font-size: 1.1rem; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            ‚ö†Ô∏è Process Failed ‚ö†Ô∏è
                        </h4>
                    </div>
                    <div class="mb-2" style="font-size: 0.8rem; opacity: 0.95;">
                        <div class="mb-1">‚ùå IKK-IK automation error</div>
                        <div style="font-size: 0.75rem; opacity: 0.8;">Check log for details</div>
                    </div>
                    <button class="btn btn-light btn-sm px-3" onclick="closeNotification('errorNotification')" style="border-radius: 15px; font-weight: 600; font-size: 0.8rem;">
                        <i class="bi bi-exclamation-triangle me-1"></i>Check Log
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                closeNotification('errorNotification');
            }, 8000);
        }

        function closeNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function toggleLog() {
            const logSection = document.getElementById('processLog');
            const toggleBtn = document.getElementById('logToggle');
            const floatingBtn = document.getElementById('floatingLogBtn');
            
            if (logVisible) {
                logSection.classList.remove('show');
                toggleBtn.innerHTML = '<i class="bi bi-eye me-1"></i>Show Log';
                floatingBtn.style.display = 'block';
                logVisible = false;
            } else {
                logSection.classList.add('show');
                toggleBtn.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Hide Log';
                floatingBtn.style.display = 'none';
                logVisible = true;
            }
        }

        function startLogPolling() {
            // Clear any existing interval
            if (logInterval) {
                clearInterval(logInterval);
            }
            
            // Start new polling interval
            logInterval = setInterval(() => {
                fetchLog();
            }, 1000);
            
            // Also fetch immediately
            fetchLog();
        }

        function stopLogPolling() {
            if (logInterval) {
                clearInterval(logInterval);
                logInterval = null;
            }
        }

        function fetchLog() {
            const logOutput = document.getElementById('logOutput');
            fetch('/get_log', {cache: 'no-store'})
                .then(response => response.text())
                .then(data => {
                    if (data && data.trim() !== '') {
                        if (logOutput.textContent !== data) {
                            logOutput.textContent = data;
                            logOutput.scrollTop = logOutput.scrollHeight;
                        }
                    } else {
                        logOutput.textContent = 'üí¨ Waiting for process to start...';
                    }
                })
                .catch(error => {
                    logOutput.textContent = '‚ùå Error fetching log!';
                    console.error('Error fetching log:', error);
                });
        }

        function stopProcess() {
            const processBtn = document.getElementById('processBtn');
            const stopBtn = document.getElementById('stopBtn');
            const logOutput = document.getElementById('logOutput');
            
            // Stop log polling
            stopLogPolling();
            
            // Update UI
            processBtn.innerHTML = '<i class="bi bi-stop-circle me-1"></i>Stopped';
            processBtn.disabled = false;
            processBtn.className = 'btn btn-secondary';
            stopBtn.style.display = 'none';
            
            // Add stop message to log
            logOutput.textContent += '\nüõë Process stopped by user';
            
            // Reset button after 3 seconds
            setTimeout(() => {
                updateButtonText();
            }, 3000);
            
            // Send stop signal to backend
            fetch('/stop_process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(response => response.json())
            .then(data => {
                console.log('Stop signal sent to backend');
                logOutput.textContent += '\nüîÑ Cleanup process initiated...';
            })
            .catch(error => {
                console.error('Error stopping process:', error);
                logOutput.textContent += '\n‚ùå Error stopping process';
            });
        }

        function clearLog() {
            const logOutput = document.getElementById('logOutput');
            logOutput.textContent = 'üí¨ Preparing to start automation...';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateButtonText();
            
            // Initialize with default shift (simple like IKH)
            selectShift(1);
        });
    </script>
</body>
</html>
